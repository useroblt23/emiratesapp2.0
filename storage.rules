rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    ///////////////////////////////////////////////////////////////////////////
    // HELPER FUNCTIONS
    ///////////////////////////////////////////////////////////////////////////

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }

    function isGovernor() {
      return isAuthenticated() && getUserData().role == 'governor';
    }

    function isMemberOfConversation(conversationId) {
      return isAuthenticated() &&
             request.auth.uid in firestore.get(/databases/(default)/documents/conversations/$(conversationId)).data.members;
    }

    ///////////////////////////////////////////////////////////////////////////
    // CHAT ATTACHMENTS
    ///////////////////////////////////////////////////////////////////////////
    match /attachments/{conversationId}/{messageId}/{fileName} {
      // Read: Only conversation members can download
      allow read: if isMemberOfConversation(conversationId) || isGovernor();

      // Write: Only authenticated users can upload (validation done in app)
      allow write: if isAuthenticated() && isMemberOfConversation(conversationId);

      // Governors can delete
      allow delete: if isGovernor();
    }

    ///////////////////////////////////////////////////////////////////////////
    // COURSE MATERIALS
    ///////////////////////////////////////////////////////////////////////////
    match /courses/{courseId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isGovernor() ||
        getUserData().role == 'mentor'
      );
    }

    ///////////////////////////////////////////////////////////////////////////
    // MODULE MATERIALS
    ///////////////////////////////////////////////////////////////////////////
    match /modules/{moduleId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isGovernor() ||
        getUserData().role == 'mentor'
      );
    }

    ///////////////////////////////////////////////////////////////////////////
    // USER UPLOADS (Profile Pictures, etc.)
    ///////////////////////////////////////////////////////////////////////////
    match /users/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        isGovernor()
      );
    }

    ///////////////////////////////////////////////////////////////////////////
    // PUBLIC ASSETS
    ///////////////////////////////////////////////////////////////////////////
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if isGovernor();
    }

    ///////////////////////////////////////////////////////////////////////////
    // GOVERNOR ACCESS (All paths)
    ///////////////////////////////////////////////////////////////////////////
    match /{allPaths=**} {
      allow read, write: if isGovernor();
    }
  }
}
